(ql:quickload :esrap)

(defpackage :esrap-scratch
  (:use :cl :esrap :snow-match))


(in-package :esrap-scratch)

;;; A semantic predicate for filtering out double quotes.

(defun not-doublequote (char)
  (not (eql #\" char)))

(defun not-integer (string)
  (when (find-if-not #'digit-char-p string)
    t))


;; Identifier = [:letter:]([:letter:] | [:digit:])*
;; Integer    = [:digit:] [:digit:]*

#|
program = block "." .

block = [ "const" ident "=" number {"," ident "=" number} ";"]
        [ "var" ident {"," ident} ";"]
        { "procedure" ident ";" block ";" } statement .
statement = [ ident ":=" expression | "call" ident |
            "begin" statement {";" statement } "end" |
            "if" condition "then" statement |
            "while" condition "do" statement ].
condition = "odd" expression |
            expression ("="|"#"|"<"|"<="|">"|">=") expression .
expression = [ "+"|"-"] term { ("+"|"-") term}.
term = factor {("*"|"/") factor}.
factor = ident | number | "(" expression ")".
|#


(defrule whitespace (+ (or #\space #\tab #\newline))
  (:constant nil))

(defrule digit (or #\0 #\1 #\2 #\3 #\4 #\5 #\6 #\7 #\8 #\9))
#|(defrule integer (+ (or "0" "1" "2" "3" "4" "5" "6" "7" "8" "9"))
  (:lambda (list)
    (parse-integer (text list) :radix 10)))|#

(defrule letter (or . #.(mapcar #'string (coerce "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz" 'list)))
  (:lambda (c)
    (string-upcase c)))

(parse 'letter "z")

(defrule number (and (? whitespace)
                     (+ digit)
                     (? whitespace))
  (:destructure (space list space2)
                (declare (ignore space space2))
                (parse-integer (format nil "窿扉篝┅┅疳蝮ь蹴忮⒏父ㄤ彐蝓戾殇孱ㄡ钿麒轸弩疳沐戾趑弪í矧戾趑弪溟玳舂麒轸弩疳沐┅ê溴篝蝓泗躜箴徙桢徜翎殪箴徙宀ㄤ邈灬蝈ㄩ珙矧箴徙箴徙宀┅ㄩ铘弪ㄦ矧磲铋窿窿桢徜翎殪┅┅疳蝮ч溴铘羔跟父ê溴篝蝓泗躜痦舯舨箪汉骒狒翦扉篝痦舯舨┅ㄤ彐蝓戾屮痱弩箝镱ㄡ钿麒轸弩疳沐矧＼＼┅翦蝽íㄡ钿矧＼＼翦蝽┅ê灬礅溽ㄥ皓磲翥屮è紊紊鲠紊泰鲠颟è紊鲠紊泰啜鲠颟è紊鲠紊泰啜鲠颟è紊紊鲠┅啜鲠括磲疸狎灬礅溽磲翥è鲠颟啜鲠颟è鲠颟啜鲠颟ㄥ屮皓┅颟┅è紊骖鲠┅啜ìㄩ铘弪骖恒飑鲠颟括磲疸狎灬礅溽磲翥è鲠颟啜鲠颟è鲠颟啜鲠颟ㄥ屮皓┅颟┅ㄥ屮皓┅疳蝮у痱弩箝镱⑩後涪紊紊ㄎ商ǜ紊泰紊疳蝮у痱弩箝镱⒏幄紊紊ǐèǜ┅áǜ┅┅紊紊ê溴篝蝓泗躜ㄦ娌箪汉骒狒翦扉篝姹娌┅ㄤ彐蝓戾翦蝽ㄡ钿驷泗矧íㄡ钿矧＼＼驷泗矧┅ê灬礅溽ㄥ皓磲翥屮è铋飑è┅啜括磲疸狎灬礅溽磲翥è鲠颟啜鲠颟è鲠颟啜鲠颟ㄥ屮皓┅颟┅ㄥ屮皓┅疳蝮翦蝽⒏疳蝮翦蝽⒏腐涪ǜè俯á俯á俯┅紊紊ê灬礅溽ㄩㄡ麸戾è怙澌ㄣ潋ㄢ豸灬篝┅┅ㄣ镱ю蝻珙怙澌┅ㄤ彐蝓戾驷泗矧矧殇孱铛礅弪ㄡ钿＼屮痱弩箝镱＼┅ê灬礅溽ㄥ皓磲翥屮èá篚啜痱镧篚猢ㄥ屮皓┅疳蝮ф徙麸⒏疳蝮ф徙麸⑨疳蝮ф徙麸ō斧腑瘵换ㄐ蚁俏ǐō诟ǐ俯ō雪┅紊疳蝮ф徙麸ǐ俯ê灬礅溽ㄣ镱è犷ㄡ麸ㄣ狎┅篝蜷铉⑾哪ㄣ狎┅啜镤ㄣ徜┅ㄔ┅ㄤ彐蝓戾泔钿轸轱ㄡ钿麒轸弩疳沐矧ㄡ钿⑾哪屮痱弩箝镱ㄡ钿屮痱弩箝镱矧⒔＂⒓舰⒓⒕舰⒕屮痱弩箝镱┅ê灬礅溽ㄥ皓磲翥屮è紊á夏蘑┅啜镤漯莉┅è紊＂┅啜è紊骖┅啜ㄩ铘弪骖ㄥ屮皓┅疳蝮с镱溟糸镱夏涪疳蝮с镱溟糸镱夏釜吵涪紊疳蝮с镱溟糸镱⑨ㄡ倡腐俯换殇孱⒑舰屮痱弩箝镱汜祆殇孱换⑩彗轭篝狒屙孱⒒篝狒屙孱㈠钿换㈤姊泔钿轸轱Ⅳ桢睥篝狒屙孱换Ⅶ栝戾泔钿轸轱滹篝狒屙孱ㄤ彐蝓戾篝狒屙孱ㄡ钿麒轸弩疳沐矧ㄡ钿殇孱⒑舰屮痱弩箝镱麒轸弩疳沐┅ㄡ钿⒚撂挞殇孱麒轸弩疳沐┅ㄡ钿⒙徘晌篝狒屙孱麒轸弩疳沐íㄡ钿⒒麒轸弩疳沐篝狒屙孱舂麒轸弩疳沐⑴文麒轸弩疳沐┅ㄡ钿⑸脾泔钿轸轱⒃扰微篝狒屙孱舂ㄡ钿⒆壬膛泔钿轸轱⒛息篝狒屙孱舂┅换é镳糸镱犰狍殓汜祆忮玳殒麒殪濠ê灬礅溽ㄥ皓磲翥屮è铋鲠⒑舰鲠铋飑啜箦赳鲠鲠飑è紊á昧烫骖紊泰啜骢钽犰ㄦ躅泗轱骖┅è紊á屡巧微篚紊紊紊⑴文紊泰篚猢è紊á屡巧微篚紊è⒒紊篚猹紊⑴文紊泰啜痱镧篚荔踱┅è紊á兹商泞痱邃⒛息篚猢啜麒殪痱邃篚猢è紊á善痱邃⒃扰微篚猢啜殒痱邃篚猢ㄥ屮皓┅疳蝮篝狒屙孱⒙徘晌梁礁盼蘑ㄐ蚁俏ㄓ旁俯疳蝮篝狒屙孱⒘航ǜ俯ㄓ旁ㄐ蚁俏ǐǐ俯┅疳蝮篝狒屙孱⒘航幄疳蝮篝狒屙孱⒚撂幄疳蝮篝狒屙孱屡巧航航航盎兹商南屡巧善夏匀盼航峄航峄航盼盼蘑皓痱轭疳蝮篝狒屙孱兹商南屡巧昧烫峄昧烫盼蘑疳蝮篝狒屙孱屡巧昧烫盼蘑疳蝮篝狒屙孱屡巧昧烫峄昧烫盼蘑ㄎ商á屡巧微ㄆ瘴昧烫＇俩紊è⒒紊ㄆ瘴昧烫＇俩┅紊⑴文紊泰紊紊航疳蝮篝狒屙孱兹商南屡巧善夏匀盼航峄航峄航盼疳蝮篝狒屙孱⒆壬膛南屡巧善匀盼航婊善匀盼航盼疳蝮篝狒屙孱航尝疳蝮篝狒屙孱⒚撂岢疳蝮篝狒屙孱屡巧岢航郴昧烫岢盼蘑疳蝮篝狒屙孱⑸匀盼航姊疳蝮篝狒屙孱⒙徘晌航航兹商南屡巧善匀盼航婊善匀盼航缁盼幕航盼蘑换忪镢泔铙簪殇孱⒔铛礅弪殇孱⒔铛礅弪⒒⑤换Ⅵ狎殇孱殇孱酏⒒⑤换痱镢邃躜澧殇孱⒒忪镢⒒篝狒屙孱ㄤ彐蝓戾忪镢ㄡ钿麒轸弩疳沐ㄡ钿麒轸弩疳沐⒚衔釉殇孱⒔铛礅弪íㄡ钿殇孱⒔铛礅弪┅⒒┅ㄡ钿麒轸弩疳沐⒅烈殇孱íㄡ钿殇孱舂⒒┅íㄡ钿麒轸弩疳沐⑿蚁门恼遗麒轸弩疳沐殇孱麒轸弩疳沐⒒麒轸弩疳沐忪镢⒒┅麒轸弩疳沐篝狒屙孱舂ê灬礅溽ㄥ皓磲翥屮è殓铒蝈泔铙舡沆狨箦鲠颦沆狨箦è紊⑿蚁门恼遗紊钺礤紊⒒紊忪镢⒒紊篝狒屙孱舂啜痱镧磲翥泔铙舡沆狨箦è紊⒚衔釉斌舡鲠⒔斌舡鲠ú钿⒒啜痱镧ㄤ彐泔铙翎铘斌舡鲠斌舡鲠飑括磲翥差洵èá鲠⒔鲠飑磲疸狎灬礅溽飑啜溴驺镱篝犷飑鲠鲠飑┅┅ㄥ屮皓磲翥鲠颦沆狨箦è紊⒅烈斌ú钿⒒啜痱镧ㄤ彐鲠斌舂括磲翥差洵èá鲠颟磲疸狎灬礅溽啜溴骣狎┅鲠颟┅┅ㄥ屮皓｜ㄤ彐躅钺礤括磲翥忪镢èīīè⒅烈斌ú钿⒒īī啜ì斌括磲疸狎＇箦泔钿差洵┅棱┅ㄥ屮皓┅括磲疸狎灬礅溽钺礤屮皓啜溴骢钺礤括磲翥屮è幸锨īě幸锨ě呐浦烈鲠颟怙澌啜ī戾ì丽狎ㄤ邈灬蝈箴邈獒丽狎┅怙澌┅┅┅钺礤忪镢氅换痱轭扉篝衡祜汶忪镢氅痱镧篝狒屙孱舂┅ㄥ屮皓┅痱轭疳蝮р祜汶孟斡番傅至瘳蚧幸厦拍找眭祠轲禊至岈饣屡巧航航航盎兹商南屡巧善夏匀盼航峄航峄航盼盼幕幸厦拍找溟鲩溴至骰屡巧航航盎航兹商冀南航骰兹商南屡巧航窕航不善冀匀盼屡巧航骰航盼盼盼幕幸厦拍找玢浠至娆缁屡巧航航兹商南屡巧善匀盼航婊善匀盼航盼幕航盼幕屡巧航砘航罨昧烫眭祠轲禊航驳航郴昧烫溟鲩溴航复航扯昧烫玢盼蘑┅疳蝮р祜汶孟斡峤超饨郴至岈猬慊幸厦拍找骘锘昧烫岢昧烫岢疳蝮р祜汶幸厦拍找骘锘昧烫岢昧烫岢疳蝮р祜汶⒚衔釉峤超饨够至岈猬慊幸厦拍找骘锘昧烫岢幻撂岢疳蝮ю蝻珧犴⒚衔釉峤超饨够至岈猬慊幸厦拍找骘锘昧烫岢屡巧昧烫岢盼漠痱轭皓换痱镧蜥忪镢ㄤ彐蝓戾痱镧蜥ㄡ钿麒轸弩疳沐忪镢麒轸弩疳沐麒轸弩疳沐┅ê灬礅溽ㄥ皓磲翥屮è铋忪镢殓铒蝈忪镢氅┅痱轭皓疳蝮ю蝻珧犴孟斡峤超饨够至岈猬慊幸厦拍找玢浠至娆缁屡巧航航兹商南屡巧善匀盼航婊善匀盼航盼幕航盼幕昧烫骘锂疳蝮ю蝻珧犴孟斡峤超饨够至岈猬慊幸厦拍找玢浠至娆缁屡巧航航兹商南屡巧善匀盼航婊善匀盼航盼幕航盼幕昧烫骘锂ㄐ蚁俏ㄐ蚁俏呐泼衔釉廖畅呐泼衔釉廖供ㄐ蚁俏呐浦烈俩呐浦烈漏呐浦烈茅呐普敲ㄆ签ㄐ蚁俏ㄓ旁丞ㄓ旁侃ㄗ壬膛ǒ签ㄐ蚁俏ㄉ签ㄓ旁ǐō譬┅ㄉ譬ㄓ旁ǐō签┅┅ㄓ旁譬┅ㄐ蚁俏ㄆ瘴昧烫＇葡烯┅紊换至篑趸疳蝮с镱溟糸镱疳蝮篝狒屙孱屡巧屡巧善匀盼屡巧昧烫盼盼幕屡巧昧烫岢盼盼疳蝮р祜汶幸厦拍找骘锘至岈饣昧烫岢昧烫岢疳蝮р祜汶幸厦拍找眭祠轲禊至岈饣屡巧航航航盎兹商南屡巧善夏匀盼航峄航峄航盼盼幕屡巧昧烫眭祠轲禊盼蘑痱轭皓疳蝮ю蝻珧犴⒚衔釉番傅至瘳蚧幸厦拍找眭祠轲禊至岈饣屡巧航航航盎兹商南屡巧善夏匀盼航峄航峄航盼盼幕幸厦拍找溟鲩溴至骰屡巧航航盎航兹商冀南航骰兹商南屡巧航窕航不善冀匀盼屡巧航骰航盼盼盼幕幸厦拍找玢浠至娆缁屡巧航航兹商南屡巧善匀盼航婊善匀盼航盼幕航盼幕屡巧航砘航罨昧烫眭祠轲禊航驳航郴昧烫溟鲩溴航复航扯昧烫玢盼漠ㄐ蚁俏ㄐ蚁俏呐泼衔釉廖珐呐泼衔釉廖傅┅ㄐ蚁俏呐浦烈丞呐浦烈侃呐浦烈讴呐浦烈雪呐浦烈药呐普驼淘尚藤īㄌ旁漏呐锰烈ㄓ信蒙撂漏ㄐ蚁俏ㄐ蚁俏ㄓ旁丞ㄓ旁侃ㄓ旁癌ㄗ壬膛癌ㄐ蚁俏ㄉㄏ哪漏ㄓ旁ǐǐ俩┅ㄓ旁íí俩┅ㄓ旁íǒ博┅┅┅┅呐普纳稚呐īㄌ旁ㄗ呐锰烈ㄓ信蒙撂砖ㄐ蚁俏ㄐ蚁俏ㄓ旁丞ㄓ旁癌ㄓ旁侃ㄗ壬膛冀药ㄓ旁íí砖┅ㄗ壬膛侃ㄐ蚁俏ㄓ旁íí雪┅ㄓ旁íǒ博┅ㄉ冀药ㄐ蚁俏ㄓ旁ǐō砖┅ㄓ旁ǐǐ暴┅┅┅┅┅呐普敲īㄌ旁ㄆ签呐锰烈ㄓ信蒙撂签ㄐ蚁俏ㄐ蚁俏ㄓ旁丞ㄓ旁侃ㄗ壬膛ǒ签ㄐ蚁俏ㄉ签ㄓ旁ǐō譬┅ㄉ譬ㄓ旁ǐō签┅┅ㄓ旁譬┅┅ㄐ蚁俏ㄐ蚁俏ㄓ旁桐ㄓ旁惟ㄆ瘴昧烫＇驼淘尚藤ㄓ旁驳ㄓ旁畅ㄆ瘴昧烫＇纳稚呐ㄓ旁复ㄓ旁扯ㄆ瘴昧烫＇敲末┅紊ㄤ彐躅ī疳蝮ю蝻珧犴腱候遽洵骈戾麸篝蜷铉栾礤磴戾狎畀沆弩蜥鸠痨碍筢眇戾痨阿┅皓ㄐ蚁俏ㄐ蚁俏呐泼衔釉廖珐呐泼衔釉廖傅┅ㄐ蚁俏呐浦烈丞呐浦烈侃呐浦烈讴呐浦烈雪呐浦烈药呐普驼淘尚藤īㄌ旁漏呐锰烈ㄓ信蒙撂漏ㄐ蚁俏ㄐ蚁俏ㄓ旁丞ㄓ旁侃ㄓ旁癌ㄗ壬膛癌ㄐ蚁俏ㄉㄏ哪漏ㄓ旁ǐǐ俩┅ㄓ旁íí俩┅ㄓ旁íǒ博┅┅┅┅呐普纳稚呐īㄌ旁ㄗ呐锰烈ㄓ信蒙撂砖ㄐ蚁俏ㄐ蚁俏ㄓ旁丞ㄓ旁癌ㄓ旁侃ㄗ壬膛冀药ㄓ旁íí砖┅ㄗ壬膛侃ㄐ蚁俏ㄓ旁íí雪┅ㄓ旁íǒ博┅ㄉ冀药ㄐ蚁俏ㄓ旁ǐō砖┅ㄓ旁ǐǐ暴┅┅┅┅┅呐普敲īㄌ旁ㄆ签呐锰烈ㄓ信蒙撂签ㄐ蚁俏ㄐ蚁俏ㄓ旁丞ㄓ旁侃ㄗ壬膛ǒ签ㄐ蚁俏ㄉ签ㄓ旁ǐō譬┅ㄉ譬ㄓ旁ǐō签┅┅ㄓ旁譬┅┅ㄐ蚁俏ㄐ蚁俏ㄓ旁桐ㄓ旁惟ㄆ瘴昧烫＇驼淘尚藤ㄓ旁驳ㄓ旁畅ㄆ瘴昧烫＇纳稚呐ㄓ旁复ㄓ旁扯ㄆ瘴昧烫＇敲末┅紊换